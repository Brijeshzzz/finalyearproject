<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì° Multi-Channel SDR System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        
        /* GENERAL STYLES - (Unchanged) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f0f23;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Animated background - (Unchanged) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.3), transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(168, 85, 247, 0.2), transparent 50%);
            animation: gradientShift 15s ease infinite;
            z-index: -1;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header - (Unchanged) */
        .header { text-align: center; margin-bottom: 50px; animation: fadeInDown 0.8s ease; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .header h1 {
            font-size: 3em; font-weight: 800;
            background: linear-gradient(135deg, #a7b7ff 0%, #667eea 50%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 5px; letter-spacing: -1px;
        }
        .header .subtitle { font-size: 1.3em; color: #a0aec0; font-weight: 300; }

        /* Glass card effect - (Unchanged) */
        .glass-card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            padding: 30px; margin-bottom: 25px; transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px); box-shadow: 0 16px 50px rgba(0, 0, 0, 0.5); border-color: rgba(255, 255, 255, 0.3);
        }

        /* Connection Status - (Unchanged) */
        .connection-status { padding: 20px; border-radius: 16px; font-weight: 700; text-align: center; font-size: 1.2em; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; margin-bottom: 30px; }
        .status-dot { width: 14px; height: 14px; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
        .connection-status.connected { background: linear-gradient(135deg, #10b981, #059669); border-color: #10b981; }
        .connection-status.disconnected { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .connection-status.connecting { background: linear-gradient(135deg, #f59e0b, #d97706); }

        /* --- DASHBOARD LAYOUT CHANGE --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr; /* Now a single column for the main content block */
            gap: 30px; 
            margin-bottom: 30px;
        }
        
        /* New Grid for 4 Real-Time Waves */
        .quad-chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, minmax(220px, 1fr)); /* Fixed height rows for charts */
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .quad-chart-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-panel {
            min-height: 220px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .channel-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #e5e7eb;
        }

        .channel-data {
            font-size: 1.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #a7b7ff, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .alert-indicator {
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .alert-indicator.inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .alert-indicator.active {
            background: #ff8a00;
            color: #0f0f23;
            animation: flash 1s infinite alternate;
            box-shadow: 0 0 10px #ff8a00;
        }
        
        @keyframes flash {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
        
        /* Stats Grid - Now a dedicated 4-column row */
        .stats-grid-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px; 
            margin-bottom: 30px;
        }
        @media (max-width: 1200px) {
            .stats-grid-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            .stats-grid-row {
                grid-template-columns: 1fr;
            }
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.08); 
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-align: center;
        }

        .stat-label { font-size: 0.9em; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        .stat-value {
            font-size: 2.2em; font-weight: 800;
            background: linear-gradient(135deg, #a7b7ff, #667eea);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        
        /* --- Chart Styling for Sparklines --- */
        .chart-container {
            position: relative;
            height: 150px; /* Reduced height for sparklines */
        }
        
        /* Controls Section and below - (Unchanged structure) */
        .controls-section h3 { font-size: 1.5em; font-weight: 800; margin-bottom: 25px; color: #fff; }
        .button-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        @media (max-width: 768px) { .button-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); } }
        button { padding: 18px 24px; border: none; border-radius: 14px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        /* ... (Rest of button, input, and log styles remain the same) ... */

        .input-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        @media (max-width: 1200px) { .input-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .input-grid { grid-template-columns: 1fr; } }

        /* Setup Guide - (Unchanged structure) */
        .setup-guide { background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 24px; padding: 30px; margin-bottom: 30px; animation: fadeIn 1s ease; }
        .setup-steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        /* ... (Rest of setup guide styles) ... */

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° Remote Sensing using Software Defined Radio</h1>
            <p class="subtitle">Disaster Detection System for Hazardous Environments</p>
        </div>

        <div class="setup-guide glass-card">
            <h3>üöÄ System Setup Guide</h3>
            <div class="setup-steps">
                <div class="step-card">
                    <h4>üíª Laptop 1 - Transmitter (Hotspot)</h4>
                    <ol>
                        <li>Create a dedicated **WiFi Hotspot**.</li>
                        <li>Name the hotspot: <code>MotionDetect</code> (or your custom SSID).</li>
                        <li>Set a password and ensure the hotspot remains **ON**.</li>
                        <li>**Position:** Place this laptop across the area you intend to monitor (the "Trip Wire").</li>
                    </ol>
                </div>
                <div class="step-card">
                    <h4>üì° Laptop 2 - Monitor (Receiver & Analyzer)</h4>
                    <ol>
                        <li>Connect this device to the **Hotspot** created by Laptop 1.</li>
                        <li>Run the RSSI server script: <code>python laptop2_rssi_server.py</code></li>
                        <li>Enter the Hotspot **SSID** in the control panel below.</li>
                        <li>Click **Start** and observe the baseline signal before introducing motion.</li>
                    </ol>
                </div>
            </div>
        </div>

        <div id="connectionStatus" class="connection-status disconnected glass-card">
            <span class="status-dot"></span>
            <span>System Ready - Configure & Start</span>
        </div>
        
        <div class="glass-card">
             <h3 class="chart-title">üìä Multi-Channel SDR Analysis</h3>
            
            <div class="stats-grid-row">
                <div class="stat-box">
                    <div class="stat-label">MAX ST. DEVIATION (œÉ)</div>
                    <div class="stat-value" id="maxStdDev">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">TOTAL ALERTS</div>
                    <div class="stat-value" id="motionCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">TOTAL SAMPLES</div>
                    <div class="stat-value" id="sampleCount">0</div>
                </div>
                 <div class="stat-box">
                    <div class="stat-label">AVG POWER (dBm)</div>
                    <div class="stat-value" id="avgRssi">--</div>
                </div>
            </div>
            
            <div class="quad-chart-grid">
                
                <div class="glass-card chart-panel">
                    <div class="chart-header">
                        <div>
                            <span class="channel-title">CH 1: 2412 MHz</span>
                            <div class="channel-data" id="freq1Value">-- dBm</div>
                        </div>
                         <div id="alertIndicator1" class="alert-indicator inactive">NO MOTION</div>
                    </div>
                    <div class="chart-container"><canvas id="rssiChart1"></canvas></div>
                </div>
                
                <div class="glass-card chart-panel">
                    <div class="chart-header">
                        <div>
                            <span class="channel-title">CH 6: 2437 MHz</span>
                            <div class="channel-data" id="freq2Value">-- dBm</div>
                        </div>
                        <div id="alertIndicator2" class="alert-indicator inactive">NO MOTION</div>
                    </div>
                    <div class="chart-container"><canvas id="rssiChart2"></canvas></div>
                </div>
                
                <div class="glass-card chart-panel">
                    <div class="chart-header">
                        <div>
                            <span class="channel-title">CH 11: 2462 MHz</span>
                            <div class="channel-data" id="freq3Value">-- dBm</div>
                        </div>
                        <div id="alertIndicator3" class="alert-indicator inactive">NO MOTION</div>
                    </div>
                    <div class="chart-container"><canvas id="rssiChart3"></canvas></div>
                </div>
                
                <div class="glass-card chart-panel">
                    <div class="chart-header">
                        <div>
                            <span class="channel-title">SDR: 433 MHz</span>
                            <div class="channel-data" id="freq4Value">-- dBm</div>
                        </div>
                        <div id="alertIndicator4" class="alert-indicator inactive">NO MOTION</div>
                    </div>
                    <div class="chart-container"><canvas id="rssiChart4"></canvas></div>
                </div>
                
            </div>
            
        </div>
        
        <div class="glass-card controls-section">
            <h3>‚öô Control Center</h3>
            
            <div class="button-grid">
                <button class="btn-primary" id="startBtn" onclick="startMonitoring()">
                    üöÄ START MONITORING
                </button>
                <button class="btn-danger" onclick="stopMonitoring()">
                    ‚èπ STOP
                </button>
                <button class="btn-secondary" onclick="calibrate()">
                    üéØ CALIBRATE BASELINE
                </button>
                <button class="btn-secondary" onclick="resetData()">
                    üîÑ RESET DATA
                </button>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label for="ssidName">üì° Signal Transmitter Name (SSID)</label>
                    <input type="text" id="ssidName" value="MotionDetect" placeholder="Enter hotspot name">
                </div>
                
                <div class="input-group">
                    <label for="threshold">üéö Motion Threshold (Std Dev in dB)</label>
                    <input type="number" id="threshold" value="3.0" min="0.5" max="15" step="0.5">
                </div>
                
                <div class="input-group">
                    <label for="windowSize">üìè Analysis Window (Samples)</label>
                    <input type="number" id="windowSize" value="8" min="4" max="30">
                </div>
                
                <div class="input-group">
                    <label for="updateRate">‚è± Update Rate (ms)</label>
                    <input type="number" id="updateRate" value="500" min="100" max="2000" step="100">
                </div>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry success">üü¢ System initialized and ready</div>
                <div class="log-entry info">üí° Tip: Use <kbd>Ctrl</kbd> + <kbd>Space</kbd> for quick start/stop</div>
            </div>
        </div>
    </div>

    <script>
        // --- MULTI-CHANNEL DATA STRUCTURE ---
        let channelData = {
            1: { freq: 2412, data: [], chart: null, elementId: 'rssiChart1', valueId: 'freq1Value', alertId: 'alertIndicator1', baseline: -45 - Math.random() * 10 },
            2: { freq: 2437, data: [], chart: null, elementId: 'rssiChart2', valueId: 'freq2Value', alertId: 'alertIndicator2', baseline: -45 - Math.random() * 10 },
            3: { freq: 2462, data: [], chart: null, elementId: 'rssiChart3', valueId: 'freq3Value', alertId: 'alertIndicator3', baseline: -45 - Math.random() * 10 },
            4: { freq: 433,  data: [], chart: null, elementId: 'rssiChart4', valueId: 'freq4Value', alertId: 'alertIndicator4', baseline: -45 - Math.random() * 10 }
        };
        let timeLabels = [];
        let maxDataPoints = 60;
        let monitoringInterval;
        let sampleCount = 0;
        let motionCount = 0;
        
        // Helper function for Chart setup
        function createChart(ctx, data, color) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 150);
            gradient.addColorStop(0, `${color}66`); // 40% opacity
            gradient.addColorStop(1, `${color}00`); // 0% opacity

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        data: data,
                        borderColor: color,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 100 },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        y: { 
                            display: false, /* Hide Y-axis for sparkline */
                            min: -85, 
                            max: -30,
                        },
                        x: { display: false } /* Hide X-axis */
                    },
                    layout: { padding: 0 }
                }
            });
        }
        
        // Initialize all 4 charts
        Object.keys(channelData).forEach(key => {
            const channel = channelData[key];
            const ctx = document.getElementById(channel.elementId).getContext('2d');
            let color = key % 2 === 0 ? '#10b981' : '#667eea';
            if (key === '4') color = '#ff8a00'; // Unique color for custom SDR
            channel.chart = createChart(ctx, channel.data, color);
        });

        // --- CORE LOGIC ---
        
        function addLog(message, type = 'info') {
            // (Log logic remains the same)
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const icon = { info: 'üîµ', error: 'üî¥', warning: 'üü°', success: 'üü¢' }[type] || 'üîµ';
            entry.textContent = `${icon} [${timestamp}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            while (logContainer.children.length > 25) { logContainer.removeChild(logContainer.lastChild); }
        }

        async function getRSSI(channelIndex) {
            // Placeholder for real SDR call. Currently returns simulated data.
            return getSimulatedRSSI(channelIndex);
        }

        function getSimulatedRSSI(channelIndex) {
            const channel = channelData[channelIndex];
            
            // Introduce bias for different channels (e.g., Ch 4 is weaker/custom)
            let bias = 0;
            if (channel.freq === 433) bias = -10;
            
            let rssi = channel.baseline + bias + (Math.random() - 0.5) * 3;
            
            // Simulate a strong motion drop (only affects one channel heavily)
            if (Math.random() > 0.95 && channelIndex === 1) {
                rssi -= 10 + Math.random() * 15;
            } else if (Math.random() > 0.98) {
                rssi -= 5 + Math.random() * 5;
            }
            
            return rssi; 
        }
        
        async function addDataPoint() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            timeLabels.push(timeStr);
            sampleCount++;
            
            let totalRssi = 0;
            let maxStdDev = 0;

            for (const key in channelData) {
                const channel = channelData[key];
                const rssi = await getRSSI(key); // Fetch new data point
                
                channel.data.push(rssi);
                totalRssi += rssi;
                
                if (channel.data.length > maxDataPoints) {
                    channel.data.shift();
                }

                // Update chart
                channel.chart.data.labels = timeLabels;
                channel.chart.update('none');

                // Detect motion and update local stats
                const stdDev = detectMotion(key);
                document.getElementById(channel.valueId).textContent = `${rssi.toFixed(1)} dBm`;
                
                if (stdDev > maxStdDev) maxStdDev = stdDev;
            }
            
            if (timeLabels.length > maxDataPoints) {
                timeLabels.shift();
            }

            // Update Global Stats
            document.getElementById('sampleCount').textContent = sampleCount;
            document.getElementById('avgRssi').textContent = `${(totalRssi / 4).toFixed(1)} dBm`;
            document.getElementById('maxStdDev').textContent = maxStdDev.toFixed(2);
        }
        
        function detectMotion(channelKey) {
            const channel = channelData[channelKey];
            const windowSize = parseInt(document.getElementById('windowSize').value);
            const threshold = parseFloat(document.getElementById('threshold').value);
            
            if (channel.data.length < windowSize) return 0;
            
            const recentData = channel.data.slice(-windowSize);
            const mean = recentData.reduce((a, b) => a + b) / recentData.length;
            const variance = recentData.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / recentData.length;
            const stdDev = Math.sqrt(variance); 
            
            const recentDrop = mean - channel.data[channel.data.length - 1];
            
            const isMotion = (stdDev > threshold) || (recentDrop > threshold * 1.5);

            const alertIndicator = document.getElementById(channel.alertId);
            
            if (isMotion) {
                alertIndicator.classList.remove('inactive');
                alertIndicator.classList.add('active');
                alertIndicator.textContent = 'ALERT!';
                
                if (alertIndicator.dataset.wasActive !== 'true') {
                    motionCount++;
                    document.getElementById('motionCount').textContent = motionCount;
                    addLog(`[${channel.freq} MHz] ALERT! Std Dev: ${stdDev.toFixed(2)} > Threshold: ${threshold}`, 'error');
                }
                alertIndicator.dataset.wasActive = 'true';
            } else {
                alertIndicator.classList.remove('active');
                alertIndicator.classList.add('inactive');
                alertIndicator.textContent = 'NO MOTION';
                alertIndicator.dataset.wasActive = 'false';
            }
            
            return stdDev;
        }
        
        // --- CONTROL FUNCTIONS (Start/Stop/Reset/Calibrate) ---

        function updateConnectionStatus(status) {
            // (Update status logic remains the same)
            const statusEl = document.getElementById('connectionStatus');
            const statusText = statusEl.querySelector('span:last-child');
            statusEl.className = 'connection-status glass-card ' + status;
            
            if (status === 'connected') {
                statusText.textContent = 'Connected & Monitoring Active';
            } else if (status === 'connecting') {
                statusText.textContent = 'Attempting Connection...';
            } else {
                statusText.textContent = 'System Ready - Configure & Start';
            }
        }
        
        async function startMonitoring() {
            // (Start logic simplified, relying on internal simulation)
            const ssid = document.getElementById('ssidName').value.trim();
            
            if (!ssid) { addLog('Please enter Signal Transmitter Name (SSID)!', 'error'); return; }
            stopMonitoring();
            
            addLog(`Starting multi-channel monitoring...`, 'info');
            updateConnectionStatus('connecting');
            
            setTimeout(() => {
                updateConnectionStatus('connected');
                addLog(`Monitoring started! Observing 4 channels.`, 'success');
                
                const updateRate = parseInt(document.getElementById('updateRate').value);
                
                monitoringInterval = setInterval(addDataPoint, updateRate);
                
                document.getElementById('startBtn').disabled = true;
            }, 1500); 
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            updateConnectionStatus('disconnected');
            document.getElementById('startBtn').disabled = false;
            addLog('Monitoring stopped by user.', 'warning');
        }
        
        function resetData() {
            stopMonitoring();
            
            // Reset all channel data
            Object.keys(channelData).forEach(key => {
                channelData[key].data = [];
                channelData[key].chart.update();
                document.getElementById(channelData[key].valueId).textContent = '-- dBm';
                document.getElementById(channelData[key].alertId).classList.remove('active');
                document.getElementById(channelData[key].alertId).classList.add('inactive');
                document.getElementById(channelData[key].alertId).textContent = 'NO MOTION';
                channelData[key].alertId.dataset.wasActive = 'false';
                channelData[key].baseline = -45 - Math.random() * 10; // Reset baseline simulation
            });

            timeLabels = [];
            sampleCount = 0;
            motionCount = 0;
            
            document.getElementById('maxStdDev').textContent = '--';
            document.getElementById('avgRssi').textContent = '--';
            document.getElementById('sampleCount').textContent = '0';
            document.getElementById('motionCount').textContent = '0';
            
            addLog('System reset - all data cleared', 'info');
        }

        function calibrate() {
            addLog('Calibrating baseline for all channels... Keep hands clear!', 'warning');
            isCalibrating = true;
            
            setTimeout(() => {
                Object.keys(channelData).forEach(key => {
                    const channel = channelData[key];
                    const recent = channel.data.slice(-10);
                    if (recent.length > 0) {
                        const newBaseline = recent.reduce((a, b) => a + b) / recent.length;
                        channel.baseline = newBaseline;
                    }
                });
                addLog('‚úÖ Calibration complete! New baselines set.', 'success');
                isCalibrating = false;
            }, 2500);
        }


        // Keyboard shortcuts - (Unchanged)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === ' ') { e.preventDefault(); if (monitoringInterval) { stopMonitoring(); } else { startMonitoring(); } }
            if (e.ctrlKey && e.key === 'r') { e.preventDefault(); resetData(); }
        });

        // Auto-adjust chart on window resize - (Unchanged)
        window.addEventListener('resize', () => {
            Object.keys(channelData).forEach(key => channelData[key].chart.resize());
        });

        // Welcome message - (Unchanged)
        setTimeout(() => {
            addLog('Pro Tip: Use Ctrl+Space to start/stop quickly', 'info');
        }, 2000);
    </script>
</body>
</html>